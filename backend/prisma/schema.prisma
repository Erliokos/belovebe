// ------------------------------------------------------
// Datasource & Generator
// ------------------------------------------------------
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ------------------------------------------------------
// ENUMS
// ------------------------------------------------------
enum Gender {
  MALE
  FEMALE
  OTHER
}

enum LikeType {
  LIKE
  SUPERLIKE
  PASS
}

enum MatchStatus {
  ACTIVE
  UNMATCHED
}

enum PhotoStatus {
  PENDING
  APPROVED
  REJECTED
}

// ------------------------------------------------------
// USERS (authentication)
// ------------------------------------------------------
model User {
  id              String   @id @default(uuid())
  tg_id           BigInt   @unique
  email           String?  @unique
  phone           String?  @unique
  passwordHash    String?
  authProvider    String   @default("local")

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  lastLoginAt     DateTime?
  isActive        Boolean  @default(true)
  isDeleted       Boolean  @default(false)

  profile         Profile?
  likesFrom       Like[]   @relation("LikesFrom")
  likesTo         Like[]   @relation("LikesTo")
  matchesA        Match[]  @relation("MatchesA")
  matchesB        Match[]  @relation("MatchesB")
  messages        Message[]
  blocksInitiator Block[]  @relation("Blocker")
  blocksTarget    Block[]  @relation("Blocked")
}

// ------------------------------------------------------
// PROFILE (public info)
// ------------------------------------------------------
model Profile {
  id                     String   @id
  user                   User     @relation(fields: [id], references: [id])
  displayName            String?
  birthdate              DateTime?
  gender                 Gender?
  genderPreferences      Gender[]
  bio                    String?
  city                   String?
  country                String?

  lat                    Float?
  lng                    Float?

  profileCompleted       Int      @default(0)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  photos                 Photo[]
  interests              ProfileInterest[]
}

// ------------------------------------------------------
// PHOTOS
// ------------------------------------------------------
model Photo {
  id               String      @id @default(uuid())
  profileId        String
  url              String
  isProfilePhoto   Boolean     @default(false)
  moderatedStatus  PhotoStatus @default(PENDING)
  createdAt        DateTime    @default(now())
  deletedAt        DateTime?

  profile          Profile     @relation(fields: [profileId], references: [id])
}

// ------------------------------------------------------
// INTERESTS
// ------------------------------------------------------
model Interest {
  id       String               @id @default(uuid())
  name     String               @unique
  profiles ProfileInterest[]
}

model ProfileInterest {
  profileId  String
  interestId String
  weight     Int?   // optional score

  profile    Profile  @relation(fields: [profileId], references: [id])
  interest   Interest @relation(fields: [interestId], references: [id])

  @@id([profileId, interestId])
}

// ------------------------------------------------------
// LIKES
// ------------------------------------------------------
model Like {
  id          String   @id @default(uuid())
  fromUserId  String
  toUserId    String
  type        LikeType
  createdAt   DateTime @default(now())

  fromUser    User     @relation("LikesFrom", fields: [fromUserId], references: [id])
  toUser      User     @relation("LikesTo", fields: [toUserId], references: [id])

  @@unique([fromUserId, toUserId])
  @@index([fromUserId])
  @@index([toUserId])
}

// ------------------------------------------------------
// MATCHES
// ------------------------------------------------------
model Match {
  id         String       @id @default(uuid())
  userAId    String
  userBId    String
  status     MatchStatus  @default(ACTIVE)
  matchedAt  DateTime     @default(now())

  userA      User         @relation("MatchesA", fields: [userAId], references: [id])
  userB      User         @relation("MatchesB", fields: [userBId], references: [id])

  conversation Conversation?

  // ensure pair is unique regardless of order
  @@unique([userAId, userBId])
}

// ------------------------------------------------------
// CHAT & MESSAGES
// ------------------------------------------------------
model Conversation {
  id           String     @id @default(uuid())
  matchId      String?    @unique
  createdAt    DateTime   @default(now())
  lastMessageAt DateTime?

  match        Match?     @relation(fields: [matchId], references: [id])
  messages     Message[]
}

model Message {
  id              String     @id @default(uuid())
  conversationId  String
  fromUserId      String
  body            String?
  createdAt       DateTime    @default(now())
  readAt          DateTime?

  conversation    Conversation @relation(fields: [conversationId], references: [id])
  fromUser        User         @relation(fields: [fromUserId], references: [id])

  @@index([conversationId])
  @@index([fromUserId])
}

// ------------------------------------------------------
// BLOCKS
// ------------------------------------------------------
model Block {
  id          String   @id @default(uuid())
  blockerId   String
  blockedId   String
  reason      String?
  createdAt   DateTime @default(now())

  blocker     User     @relation("Blocker", fields: [blockerId], references: [id])
  blocked     User     @relation("Blocked", fields: [blockedId], references: [id])

  @@unique([blockerId, blockedId])
}
